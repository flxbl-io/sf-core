name: 'IssueOps - Test Deletion of Components'
run-name: 'Test Deletion of components -${{ github.event.issue.number }}-requested by-${{ github.event.issue.user.login }}'
on:
  issues:
    types: [ opened ]

#Set the environment variables for tracking metrics
env:
  SFPOWERSCRIPTS_DATADOG: 'true'
  SFPOWERSCRIPTS_DATADOG_HOST: '${{ secrets.DATADOG_HOST }}'
  SFPOWERSCRIPTS_DATADOG_API_KEY: '${{ secrets.DATADOG_API_KEY }}'


jobs:
  issue-analyzer:
    if: contains(github.event.issue.title, 'Ops - Test Deletion of a component')
    runs-on: ubuntu-latest
    outputs:
      components: ${{ steps.issue-analyzer-output.outputs.components }}
      targetorg: ${{ steps.issue-analyzer-output.outputs.targetorg }}
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/request-component-deletion-test.yml

      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GHA_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [ "ops" ,"ops-test-deletion-of-component"]
            })

      - name: Create Comment before intiating installation
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{github.event.issue.number}}
          token: ${{ secrets.GHA_TOKEN }}
          body: |
            Hello @${{ github.event.issue.user.login }} :wave:
            
            Your request has been received and is being processed. 
            We will attempt to delete the component(s) in the target org using an unlocked package :), 
            and will update this issue with the results.

            Please make sure to remove the component from the repository after the deletion is successful.

            Please proceed to do this activity on other orgs after you have verified the results of this activity.
            You can follow the action at this link: https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}

      - name: Set Output
        id: issue-analyzer-output
        run: |
            echo "components= ${{ steps.issue-parser.outputs.issueparser_components }}" >> "$GITHUB_OUTPUT"
            echo "targetorg= ${{ steps.issue-parser.outputs.issueparser_targetorg }}" >> "$GITHUB_OUTPUT"
          
           


  execute_action:
    needs: issue-analyzer
    uses:  flxbl-io/sfops-gh-actions/.github/workflows/delete-component-job.yml@main
    with:
       components: ${{ needs.issue-analyzer.outputs.components }}
       sbxname: ${{ needs.issue-analyzer.outputs.targetorg }}
    secrets:
       DEVHUB_SFDX_AUTH_URL: ${{ secrets.DEVHUB_SFDX_AUTH_URL }}  
      


      
  close_issue:
     runs-on: ubuntu-latest
     needs:  execute_action
     if: contains(github.event.issue.title, 'Ops - Test Deletion of a component')
     steps:

      # gh needs a repo bummer
      - uses: actions/checkout@v3

      - name: Close Issue
        run: |
         gh issue close ${{github.event.issue.number}} -c " Hello @${{ github.event.issue.user.login }} :wave: \n Your request has been sucessfully processed" -r "Completed"
        env:
           GH_TOKEN: ${{ secrets.GHA_TOKEN }}

  comment_issue_on_error:
      runs-on: ubuntu-latest
      needs:   execute_action
      if: always() && needs.execute_action.result == 'failure'
      steps:

      - name: Create Comment after failure
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{github.event.issue.number}}
          token: ${{ secrets.GHA_TOKEN }}
          body: |
            Hello @${{ github.event.issue.user.login }} :wave:
            
            Apologies, it seems we ran into an issue, This would need your manual attention please check the job run
            at the link https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}

            This means the component is coupled with another component, and cannot be deleted. You will need to manually
            delete the component from the target org and also delete the temporary package created in the devhub org.